## 3. MMU / IOMMU

μ°¨μ΄μ 

- MMUμ λ©μ 
    - CPUκ°€ λ³΄μ΄λ” κ°€μƒ μ£Όμ†λ¥Ό λ¬Όλ¦¬μ  μ£Όμ†λ΅ λ³€ν™
    - μΌλ°μ μΈ μ΄μ μ²΄μ  μμ¤€μ κ°€μƒν™” μ§€μ›
    - ν”„λ΅μ„Έμ¤μ κ°€μƒ λ©”λ¨λ¦¬ κ΄€λ¦¬
- IOMMUμ λ©μ 
    - λ³€ν™λ κ°€μƒ μ£Όμ†λ” μ¥μΉκ°€ λ³΄μ΄λ” κ°€μƒ μ£Όμ†
    - DMA μ£Όμ† λ³€ν™: I/O μ¥μΉμ DMA μ”μ²­μ— λ€ν•΄ κ°€μƒ μ£Όμ†λ¥Ό λ¬Όλ¦¬μ  μ£Όμ†λ΅ λ³€ν™

IOMMU ν•λ“μ›¨μ–΄λ¥Ό ν™μ©ν• PCI ν¨μ¤μ¤λ£¨ λ¨λΈ

![IOMMU ν•λ“μ›¨μ–΄λ¥Ό ν™μ©ν• PCI ν¨μ¤μ¤λ£¨ λ¨λΈ](images/pci_path_through.png)

μ΄κ±°λ” WMμ΄ PCIλ¬Όλ¦¬μ μ¥μΉ(SSD)λ¥Ό μ§μ ‘ μ‚¬μ©ν•  μμκ²ν•λ”κ²ƒβ†’ ν¨μ¤μ¤λ£¨ λ¨λΈIOMMUλ΅ μ•μ „ν•κ² κµ¬ν„

<aside>
π‘‰ DMAλ” I/O μ¥μΉκ°€ CPU κ°μ… μ—†μ΄ λ©”λ¨λ¦¬μ— μ§μ ‘ μ ‘κ·Όν•λ” κΈ°μ μ΄μ§€λ§, VMμ€ κ°€μƒ ν™κ²½μ—μ„ λ™μ‘ν•λ―€λ΅ κ°€μƒ λ©”λ¨λ¦¬ μ£Όμ†λ¥Ό μ‚¬μ©ν•λ”λ° λ¬Όλ¦¬μ  I/O μ¥μΉλ” μ‹¤μ  λ¬Όλ¦¬μ  λ©”λ¨λ¦¬ μ£Όμ†λ¥Ό ν•„μ”λ΅ ν•¨ μ΄ λ‘ μ£Όμ† μ²΄κ³„μ λ¶μΌμΉλ΅ μΈν•΄ VMμ—μ„ μ§μ ‘ DMAλ¥Ό μ‚¬μ©ν•  μ μ—†κ² λ©λ‹λ‹¤.

IOMMUλ” μ΄ λ¬Έμ λ¥Ό ν•΄κ²°ν•μ—¬, VMμ κ°€μƒ μ£Όμ†λ¥Ό λ¬Όλ¦¬μ  μ£Όμ†λ΅ μ•μ „ν•κ² λ³€ν™ν•κ³  μ ‘κ·Όμ„ μ μ–΄ν•¨μΌλ΅μ¨, κ°€μƒν™” ν™κ²½μ—μ„λ„ DMAμ μ„±λ¥ μ΄μ μ„ μ•μ „ν•κ² ν™μ©ν•  μ μκ² ν•΄μ¤λ‹λ‹¤.

PCI ν¨μ¤μ¤λ£¨ κΈ°μ μ€ IOMMUλ¥Ό ν™μ©ν•μ—¬ VMμ΄ λ§μΉ λ¬Όλ¦¬μ  PCI μ¥μΉμ— μ§μ ‘ μ ‘κ·Όν•λ” κ²ƒμ²λΌ λ™μ‘ν•κ² ν•΄μ£Όλ©°, μ΄λ¥Ό ν†µν•΄ VMμ€ κ±°μ λ„¤μ΄ν‹°λΈ μμ¤€μ I/O μ„±λ¥μ„ μ–»μ„ μ μμµλ‹λ‹¤.

</aside>



DMAλ” CPUλ¥Ό κ±°μΉμ§€ μ•κ³  μ…μ¶λ ¥μ¥μΉμ—μ„ λ©”λ¨λ¦¬λ΅ λ°μ΄ν„°λ¥Ό μ „μ†΅ν•λ” κΈ°λ¥

VMμ€ κ°€μƒμ£Όμ†λ¥Ό κ°€μ§€κ³  μκΈ° λ•λ¬Έμ— μ‹¤μ  λ¬Όλ¦¬μ£Όμ†λ¥Ό κ°€μ§€λ” DMAλ¥Ό ν•  μ μ—†λ‹¤

μ™λƒν•λ©΄ VMμ— μλ” GUEST OSλ„ κ°€μƒμ£Όμ†μ΄κ³  κ°€μƒν™”λ΅ λ§λ“¤μ–΄μ΅μ

κ·Έλ¬λ‚ λ°μ΄ν„°λ¥Ό μ „μ†΅μ„ ν•΄μ•Όν•λ‹¤

μ΄λ• IOMMUλ” κ°€μƒμ£Όμ†λ¥Ό λ¬Όλ¦¬μ μ£Όμ†λ΅ λ°”κΎΈλ” μ—­ν• μ„ ν•λ‹¤

VMμ΄ DMAλ¥Ό μ”μ²­ν•λ©΄ κ°€μƒμ£Όμ†λ¥Ό IOMMUλ¥Ό κ±°μ³μ„ IOMMUκ°€ κ°€μƒμ£Όμ†λ¥Ό λ¬Όλ¦¬μ  μ£Όμ†λ΅ λ°”κΎΈμ–΄μ£Όκ³  DMA μ»¨νΈλ΅¤λ¬ λ¬Όλ¦¬μ μ£Όμ† λ°›μ•„μ„ λ¬Όλ¦¬μ  λ©”λ¨λ¦¬μ™€ λ¬Όλ¦¬μ  μ…μ¶λ ¥ μ¥μΉ μ‚¬μ΄μ—μ„ λ°μ΄ν„°λ¥Ό μ „μ†΅





<aside>
π‘‰ DMAμ κΈ°λ¥: CPUλ¥Ό κ±°μΉμ§€ μ•κ³  μ…μ¶λ ¥ μ¥μΉμ™€ λ©”λ¨λ¦¬ κ°„ μ§μ ‘ λ°μ΄ν„° μ „μ†΅

VMμ μ ν•: κ°€μƒ μ£Όμ† μ‚¬μ©μΌλ΅ μ§μ ‘ DMA λ¶κ°€

IOMMUμ μ—­ν• : κ°€μƒ μ£Όμ†λ¥Ό λ¬Όλ¦¬μ  μ£Όμ†λ΅ λ³€ν™

ν”„λ΅μ„Έμ¤: VM(κ°€μƒ μ£Όμ†) -> IOMMU(μ£Όμ† λ³€ν™) -> DMA μ»¨νΈλ΅¤λ¬(λ¬Όλ¦¬μ  μ£Όμ† μ‚¬μ©) -> λ¬Όλ¦¬μ  λ©”λ¨λ¦¬μ™€ λ¬Όλ¦¬μ  μ…μ¶λ ¥ μ¥μΉ κ°„ λ°μ΄ν„° μ „μ†΅

</aside>





<aside>
π‘‰ **PCI ν¨μ¤μ¤λ£¨**

PCI ν¨μ¤μ¤λ£¨λ” VMμ΄ λ¬Όλ¦¬μ  PCI μ¥μΉμ— μ§μ ‘ μ ‘κ·Όν•  μ μκ² ν•΄μ£Όλ” κΈ°μ 

- VMμ€ κ°€μƒ μ£Όμ†λ¥Ό μ‚¬μ©ν•μ—¬ I/O μ”μ²­μ„ ν•©λ‹λ‹¤.
- IOMMUκ°€ μ΄ κ°€μƒ μ£Όμ†λ¥Ό λ¬Όλ¦¬μ  μ£Όμ†λ΅ λ³€ν™ν•©λ‹λ‹¤.
- λ³€ν™λ λ¬Όλ¦¬μ  μ£Όμ†λ¥Ό μ‚¬μ©ν•μ—¬ DMA μ»¨νΈλ΅¤λ¬κ°€ λ°μ΄ν„°λ¥Ό μ „μ†΅ν•©λ‹λ‹¤. (DMA λ¦¬λ§¤ν•‘μ΄μ©)
- λ¬Όλ¦¬μ  PCI μ¥μΉμ™€ λ¬Όλ¦¬μ  λ©”λ¨λ¦¬ κ°„μ— μ§μ ‘ λ°μ΄ν„° μ „μ†΅μ΄ μ΄λ£¨μ–΄μ§‘λ‹λ‹¤.
</aside>

### IOMMU  ν•λ” μΌ




<aside>
π‘‰ **DMA(μ§μ ‘λ©”λ¨λ¦¬μ ‘κ·Ό) λ¦¬λ§¤ν•‘ κΈ°λ¥**

- PCI μ¥μΉμ μ£Όμ† λ³€ν™μ„ μ΅°μ‘
- PCI μ¥μΉκ°€ λ©”λ¨λ¦¬μ— μ§μ ‘ μ ‘κ·Ό(DMA)ν•  λ•, IOMMUκ°€ μ¥μΉκ°€ μ‚¬μ©ν•λ” κ°€μƒ μ£Όμ†λ¥Ό μ‹¤μ  λ¬Όλ¦¬μ  μ£Όμ†λ΅ λ³€ν™
- μ΄λ¥Ό ν†µν•΄ κ°€μƒ λ¨Έμ‹ μ΄ PCI μ¥μΉλ¥Ό μ§μ ‘ μ‚¬μ©ν•  μ μμΌλ©΄μ„λ„, λ©”λ¨λ¦¬ λ³΄νΈμ™€ κ²©λ¦¬κ°€ μ μ§€λ©λ‹λ‹¤.

**μΈν„°λ½νΈ λ¦¬λ§¤ν•‘ κΈ°λ¥**

- PCI μ¥μΉ(SSD, USB) κ·Έμ μΈν„°λ½νΈλ¥Ό ν•΄λ‹Ή κ²μ¤νΈ OSλ΅ λΌμ°ν…
    - λ¬Όλ¦¬μ  PCI μ¥μΉκ°€ μΈν„°λ½νΈλ¥Ό μƒμ„±ν•©λ‹λ‹¤.
    - IOMMUμ μΈν„°λ½νΈ λ¦¬λ§¤ν•‘ κΈ°λ¥μ΄ μ΄ μΈν„°λ½νΈλ¥Ό κ°€λ΅μ±•λ‹λ‹¤.
    - λ¦¬λ§¤ν•‘ ν…μ΄λΈ”μ„ μ°Έμ΅°ν•μ—¬ μ–΄λ–¤ κ²μ¤νΈ OSκ°€ μ΄ PCI μ¥μΉλ¥Ό μ‚¬μ©ν•κ³  μλ”μ§€ ν™•μΈν•©λ‹λ‹¤.
    - μΈν„°λ½νΈλ¥Ό ν•΄λ‹Ή κ²μ¤νΈ OSμ κ°€μƒ μΈν„°λ½νΈλ΅ λ³€ν™ν•©λ‹λ‹¤.
    - λ³€ν™λ μΈν„°λ½νΈλ¥Ό μ¬λ°”λ¥Έ κ²μ¤νΈ OSλ΅ μ „λ‹¬
</aside>



**1. λ©”λ¨λ¦¬ λ³΄νΈμ™€ κ²©λ¦¬**

- IOMMUλ” I/O λ””λ°”μ΄μ¤κ°€ μ‹μ¤ν… λ©”λ¨λ¦¬μ— μ§μ ‘ μ ‘κ·Όν•λ” κ²ƒμ„ μ μ–΄ν•©λ‹λ‹¤.
- κ° I/O λ””λ°”μ΄μ¤μ— κ°€μƒ λ©”λ¨λ¦¬ μ£Όμ†λ¥Ό ν• λ‹Ήν•κ³ , μ‹¤μ  λ¬Όλ¦¬ λ©”λ¨λ¦¬μ™€ λ§¤ν•‘ν•©λ‹λ‹¤.
- μ΄λ¥Ό ν†µν•΄ ν• λ””λ°”μ΄μ¤μ λ©”λ¨λ¦¬ μ ‘κ·Όμ΄ λ‹¤λ¥Έ λ””λ°”μ΄μ¤λ‚ μ΄μμ²΄μ  μ»¤λ„ λ©”λ¨λ¦¬λ¥Ό μΉ¨λ²”ν•μ§€ μ•λ„λ΅ λ³΄νΈν•©λ‹λ‹¤.
1. **DMA(Direct Memory Access) κ΄€λ¦¬**
    - I/O λ””λ°”μ΄μ¤λ” DMAλ¥Ό ν†µν•΄ CPU κ°μ… μ—†μ΄ μ‹μ¤ν… λ©”λ¨λ¦¬μ— μ§μ ‘ μ ‘κ·Όν•  μ μμµλ‹λ‹¤.
    - IOMMUλ” DMA λ¦¬λ§¤ν•‘ κΈ°λ¥μ„ ν†µν•΄ I/O λ””λ°”μ΄μ¤μ DMAλ¥Ό κ΄€λ¦¬ν•κ³  μ μ–΄ν•©λ‹λ‹¤.
    - DMA λ¦¬λ§¤ν•‘μ€ I/O λ””λ°”μ΄μ¤κ°€ μ‚¬μ©ν•λ” κ°€μƒ μ£Όμ†λ¥Ό λ¬Όλ¦¬ λ©”λ¨λ¦¬ μ£Όμ†λ΅ λ³€ν™ν•λ” κ³Όμ •μ…λ‹λ‹¤.
    - μ΄λ¥Ό ν†µν•΄ μΉμΈλ λ©”λ¨λ¦¬ μμ—­λ§ μ ‘κ·Όν•  μ μκ² ν•μ—¬ λ¶λ²•μ μΈ λ©”λ¨λ¦¬ μ ‘κ·Όκ³Ό λ°μ΄ν„° μ†μƒμ„ λ°©μ§€ν•©λ‹λ‹¤.
2. **μΈν„°λ½νΈ λ¦¬λ§¤ν•‘**
    - I/O λ””λ°”μ΄μ¤μ—μ„ λ°μƒν• μΈν„°λ½νΈλ¥Ό μ μ ν• λ€μƒ(μ: κ²μ¤νΈ OS)μ—κ² μ „λ‹¬ν•λ” κΈ°λ¥μ…λ‹λ‹¤.
    - κ°€μƒν™” ν™κ²½μ—μ„ IOMMUλ” VM(κ°€μƒλ¨Έμ‹ )μ— ν• λ‹Ήλ I/O λ””λ°”μ΄μ¤μ μΈν„°λ½νΈλ¥Ό ν•΄λ‹Ή κ²μ¤νΈ OSλ΅ λΌμ°ν…(μ „λ‹¬)ν•©λ‹λ‹¤.
    - μ΄λ¥Ό ν†µν•΄ κ°€μƒ λ¨Έμ‹  κ°„μ I/O λ””λ°”μ΄μ¤ κ²©λ¦¬μ™€ λ³΄μ•μ„ κ°•ν™”ν•  μ μμµλ‹λ‹¤.
3. **μ‹μ¤ν… μ•μ •μ„± ν–¥μƒ**
    - IOMMUλ” λ””λ°”μ΄μ¤ λ“λΌμ΄λ²„λ‚ νμ›¨μ–΄μ λ²„κ·Έλ΅ μΈν• μ‹μ¤ν… λ¶μ•μ •μ„±μ„ μ™„ν™”μ‹ν‚µλ‹λ‹¤.
    - λ©”λ¨λ¦¬ λ³΄νΈμ™€ μ ‘κ·Ό μ μ–΄λ¥Ό ν†µν•΄ μλ»λ λ©”λ¨λ¦¬ μ°Έμ΅°λ΅ μΈν• μ‹μ¤ν… ν¬λμ‹λ¥Ό λ°©μ§€ν•©λ‹λ‹¤.
4. **κ°€μƒν™” μ§€μ›**
    - ν•λ“μ›¨μ–΄ κ°€μƒν™” ν™κ²½μ—μ„ IOMMUλ” VMμ— ν• λ‹Ήλ I/O λ””λ°”μ΄μ¤λ¥Ό μ•μ „ν•κ² κ²©λ¦¬μ‹ν‚µλ‹λ‹¤.
    - DMA λ¦¬λ§¤ν•‘κ³Ό μΈν„°λ½νΈ λ¦¬λ§¤ν•‘μ„ ν†µν•΄ κ°€μƒ λ¨Έμ‹  κ°„μ I/O λ””λ°”μ΄μ¤ κ³µμ μ™€ λ³΄μ•μ„ κ°€λ¥μΌ€ ν•©λ‹λ‹¤.